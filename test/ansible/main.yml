- hosts: all
  become: yes
  vars:
    new_hostname: test-node
    net_interface: eth0
    ipv6_subnet_full: '2600:3c03:e000:01ec::/64'
    number_ipv6: 2000
    start_port: 10000
    username: ax0n
    password: qwe123qwe
  pre_tasks:
    - name: Set a hostname
      ansible.builtin.hostname:
        name: '{{ new_hostname }}'
      tags:
        - terraform

    - name: Update apt list
      apt:
        update_cache: yes
        
    # - name: Create folder for squid
    #   file:
    #     path: /var/cache/squid
    #     state: directory
    #     owner: proxy
    #     group: proxy

  tasks:
    - name: Setup squid
      ansible.builtin.import_tasks: ./squid-proxies-v6/squid-proxies-v6.yml
      vars:
        install_dir: "{{ ansible_env.HOME }}"
        squid_dir: "{{ install_dir }}/src/squid"
        script_folder: /opt/v6proxies

    # - name: Install htpasswd
    #   apt:
    #     name:
    #       - apache2-utils
    #       - python3-passlib
    #     update_cache: yes

    # - name: Add a user to a password file and ensure permissions are set
    #   htpasswd:
    #     path: /etc/squid/passwd
    #     name: "{{ item.name }}"
    #     password: "{{ item.pass }}"
    #     owner: proxy
    #     group: proxy
    #     mode: 0640
    #   loop: "{{ creds }}"
    #   register: passwd
    
    # - name: squid is restarted
    #   service:
    #     name: squid
    #     state: restarted
    #   when: passwd is changed

    - name: Block ICMP ipv4/ipv6
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: '1'
      loop:
        - net.ipv4.icmp_echo_ignore_all
        - net.ipv6.icmp.echo_ignore_all
    
    - name: Install netdata
      ansible.builtin.import_tasks: ./netdata/tasks/main.yml
      tags:
        - netdata

  handlers:
    - name: Restart squid
      systemd:
        name: squid
        state: restarted
