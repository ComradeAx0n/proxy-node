- hosts: all
  become: yes
  vars:
    new_hostname: test-node
    net_interface: eth0
    ipv6_subnet_full: '2600:3c03:e001:2100::/64'
    number_ipv6: 2000
    start_port: 10000
    username: ax0n
    password: qwe123qwe
  pre_tasks:
    - name: Set a hostname
      ansible.builtin.hostname:
        name: '{{ new_hostname }}'
      tags:
        - terraform

    - name: Update apt list
      apt:
        update_cache: yes

  tasks:
    - name: Setup squid
      ansible.builtin.import_tasks: ./squid-proxies-v6/squid-proxies-v6.yml
      vars:
        install_dir: "{{ ansible_env.HOME }}"
        squid_dir: "{{ install_dir }}/src/squid"
        script_folder: /opt/v6proxies

    - name: Block ICMP ipv4/ipv6
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: '1'
      loop:
        - net.ipv4.icmp_echo_ignore_all
        - net.ipv6.icmp.echo_ignore_all
    
    - name: Install netdata
      ansible.builtin.import_tasks: ./netdata/tasks/main.yml
      tags:
        - netdata

  handlers:
    - name: Restart squid
      systemd:
        name: squid
        state: restarted
